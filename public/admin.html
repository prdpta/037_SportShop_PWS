<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel | SportShop</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="nav">
        <h1>SportShop Admin Panel</h1>
        <a href="/auth/logout" class="btn-logout" style="color:red; font-weight:bold; text-decoration:none;">Keluar</a>
    </div>

    <div class="container">
        <div class="card">
            <h2>Monitoring User & API Key</h2>
            <table style="width:100%; border-collapse: collapse; margin-top:20px;">
                <thead>
                    <tr style="background:#4f46e5; color:white;">
                        <th style="padding:12px; text-align:left;">Username</th>
                        <th style="padding:12px; text-align:left;">Role</th>
                        <th style="padding:12px; text-align:left;">API Key</th>
                    </tr>
                </thead>
                <tbody id="listUser">
                    <tr><td colspan="3" style="text-align:center; padding:20px;">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    async function verifikasiAkses() {
        try {
            const res = await fetch('/auth/status?t=' + Date.now());
            const data = await res.json();

            // Kita pakai logika positif saja agar tidak pusing
            if (data.loggedIn === true) {
                if (data.role === 'admin') {
                    // JIKA ADMIN -> LANJUT AMBIL DATA
                    console.log("Akses Diterima!");
                    muatDataTabel();
                    return; // Berhenti di sini, jangan jalankan alert di bawah
                }
            }

            // JIKA TIDAK MEMENUHI SYARAT DI ATAS -> TENDANG KELUAR
            alert("Akses Ditolak! Anda bukan Admin.");
            window.location.replace('/');
            
        } catch (err) {
            window.location.replace('/');
        }
    }

    async function muatDataTabel() {
        const res = await fetch('/api/monitoring');
        const users = await res.json();
        const tbody = document.getElementById('listUser');
        
        tbody.innerHTML = users.map(u => `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding:12px;">${u.username}</td>
                <td style="padding:12px;"><b>${u.role}</b></td>
                <td style="padding:12px;"><code>${u.key_value || '-'}</code></td>
            </tr>
        `).join('');
    }

    // Jalankan fungsinya
    verifikasiAkses();
</script>
</body>
</html>